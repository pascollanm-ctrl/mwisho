<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Hospital Management System</title>
  <style>
    /* BASIC RESET */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    /* GLOBAL VARIABLES */
    :root {
      --sidebar-width: 200px;
      --main-bg: #f4f7f6;
      --sidebar-bg: #1e3a8a; /* Dark Blue */
      --sidebar-text: #ffffff;
      --accent-color: #2563eb; /* Blue 600 */
      --accent-hover: #1d4ed8;
      --text-color: #1f2937;
      --border-color: #e5e7eb;
      --card-bg: #ffffff;
    }

    /* DARK MODE (Toggle in JS) */
    html[style*="invert"] {
      filter: invert(0.98) hue-rotate(180deg);
      background-color: #1f2937;
    }
    html[style*="invert"] img {
      filter: invert(1) hue-rotate(180deg);
    }
    html[style*="invert"] {
        --main-bg: #1f2937;
        --card-bg: #374151;
        --text-color: #f3f4f6;
        --border-color: #4b5563;
    }

    /* LAYOUT */
    body {
      display: flex;
      min-height: 100vh;
      background-color: var(--main-bg);
      color: var(--text-color);
    }

    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--sidebar-bg);
      color: var(--sidebar-text);
      padding: 15px 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100%;
      z-index: 100;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .sidebar .user-info {
      padding: 0 15px 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .sidebar .user-info div:first-child {
      font-weight: bold;
    }

    .nav button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      background: none;
      border: none;
      color: var(--sidebar-text);
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .nav button:hover:not(.active) {
      background-color: #374151; /* Darker Blue-Gray on hover */
    }
    .nav button.active {
      background-color: var(--accent-color);
      font-weight: bold;
      border-left: 4px solid #f97316; /* Orange accent */
    }
    .version-info {
        margin-top: auto;
        padding: 15px;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
    }

    /* MAIN CONTENT */
    .main-content {
      margin-left: var(--sidebar-width);
      flex-grow: 1;
      padding: 30px;
    }

    /* HEADER BAR */
    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .header-bar h1 {
        font-size: 1.5rem;
    }
    .header-bar span {
        font-size: 0.9rem;
        color: #6b7280;
    }
    .header-controls {
        display: flex;
        align-items: center;
    }
    .header-controls label {
        margin-right: 10px;
        font-size: 0.9rem;
    }
    .header-controls button {
        padding: 6px 12px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    /* SECTION STYLING */
    .section h3 {
        margin-bottom: 15px;
        font-size: 1.25rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 5px;
    }
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .card {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid var(--border-color);
    }
    .card h4 {
        color: #6b7280;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    .card p {
        font-size: 2rem;
        font-weight: bold;
        color: var(--accent-color);
    }

    /* FORM STYLING */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 columns for inputs */
        gap: 15px;
        margin-bottom: 20px;
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .form-grid input, .form-grid select, .form-grid textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--main-bg);
        color: var(--text-color);
    }
    /* Style for fields that span multiple columns (like notes/diagnosis) */
    .form-full-width {
        grid-column: 1 / -1; /* Spans all columns */
    }

    .form-actions {
        display: flex;
        gap: 10px;
    }
    .form-actions button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }
    #savePatient {
        background-color: #10b981; /* Green */
        color: white;
    }
    .reset-btn {
        background-color: #f3f4f6;
        color: var(--text-color);
        border: 1px solid var(--border-color) !important;
    }
    
    /* TABLE STYLING */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: var(--card-bg);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .data-table th, .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    .data-table th {
        background-color: var(--accent-color);
        color: white;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.85rem;
    }
    .data-table tr:hover {
        background-color: #f7f9fc;
    }

    /* LOGIN MODAL */
    .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
        background-color: var(--card-bg);
        margin: 15% auto;
        padding: 30px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
        border-radius: 8px;
        text-align: center;
    }
    .modal-content h3 {
        margin-bottom: 20px;
        color: var(--accent-color);
        border-bottom: none;
    }
    .modal-content input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
    }
    .modal-content button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    #demoLogin {
        background-color: #f97316; /* Orange */
        margin-top: 5px;
    }

    /* SPECIFIC SECTION STYLES */
    #triagePreview {
        background-color: #e0f2f1; /* Light Teal */
        color: #0d9488; /* Dark Teal */
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-style: italic;
    }
    #invoicePreview {
        background-color: #fffbeb; /* Light Yellow */
        color: #b45309; /* Dark Orange */
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        border: 1px dashed #f59e0b;
        display: none; /* Hidden until bill is generated */
    }
    
    /* UTILITY STYLES */
    .mb-20 { margin-bottom: 20px; }
  </style>
</head>
<body>

  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h3>MyHospital Login</h3>
      <form id="loginForm">
        <input type="text" name="username" placeholder="Username (admin or staff)" required>
        <input type="password" name="password" placeholder="Password (admin123 or staff123)" required>
        <button type="submit">Login</button>
      </form>
      <button id="demoLogin">Quick Demo Login (staff)</button>
    </div>
  </div>
  
  <div class="sidebar">
    <h2>MyHospital</h2>
    <div class="user-info">
      <div>Logged in as</div>
      <div>Staff</div>
      <small class="text-xs">admin</small>
    </div>
    
    <div class="nav" id="nav">
      <button data-target="dashboard" class="active">Dashboard</button>
      <button data-target="registration">Patient Registration</button>
      <button data-target="triage">Triage (Vitals)</button>
      <button data-target="consultation">Consultation</button>
      <button data-target="lab" disabled>Laboratory</button>
      <button data-target="pharmacy" disabled>Pharmacy</button>
      <button data-target="billing">Billing</button>
      <button data-target="reports" disabled>Reports</button>
    </div>
    
    <div class="version-info">
        <button id="logoutBtn" style="background: #ef4444; color: white; border-radius: 4px; padding: 5px 10px; font-weight: bold; margin-bottom: 10px;">Logout</button>
        <div>Version v01 — Local demo</div>
    </div>
  </div>

  <div class="main-content">
    
    <div class="header-bar">
        <div>
            <h1 id="pageTitle">Dashboard</h1>
            <span id="pageSubtitle">Quick overview</span>
        </div>
        <div class="header-controls">
            <label for="themeToggle">Dark</label>
            <input type="checkbox" id="themeToggle" checked>
        </div>
    </div>

    <div id="dashboard" class="section">
      <div class="card-grid">
        <div class="card">
          <h4>Total Patients</h4>
          <p id="statPatients">0</p>
        </div>
        <div class="card">
          <h4>Today's Visits</h4>
          <p id="statVisits">0</p>
        </div>
        <div class="card">
          <h4>Open Bills</h4>
          <p>0</p>
        </div>
        <div class="card">
          <h4>Quick Actions</h4>
          <button id="openRegistration" class="btn" style="background: #f97316; color: white; padding: 8px 12px; margin-top: 10px;">Register New Patient</button>
        </div>
      </div>
      
      <h3>Recent Activity</h3>
       <table id="dashboardPatientsTable" class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Age</th>
            <th>Phone</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>

    <div id="registration" class="section" style="display:none;">
      <h3>Register Patient</h3>
      <form id="patientForm">
        <div class="form-grid">
            <input type="text" name="ID" placeholder="Patient ID (e.g. 35353535)" required>
            <input type="text" name="Name" placeholder="Full Name (e.g. JOSE MAGDA)" required>
            <input type="text" name="Phone" placeholder="Phone Number (e.g. 0711214268)" required>
            
            <select name="Gender" required>
                <option value="">-- Select Gender --</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
            <input type="number" name="Age" placeholder="Age" required>
            <input type="text" name="Address" placeholder="Address/Town">
        </div>
        <div class="form-actions">
            <button type="submit" id="savePatient">Save patient</button>
            <button type="reset" class="reset-btn">Reset</button>
        </div>
      </form>

      <h3 style="margin-top: 30px;">Patients List</h3>
      <input type="text" placeholder="Search by name or ID..." style="width: 300px; padding: 8px; margin-bottom: 10px;">
       <table id="patientsTable" class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Age</th>
            <th>Phone</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>

    <div id="triage" class="section" style="display:none;">
        <h3>Record Patient Vitals</h3>
        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
            <select id="triageSelectPatient" required class="form-full-width">
                <option value="">-- Select Patient --</option>
                </select>
            
            <input type="text" id="bp" placeholder="Blood Pressure (e.g. 120/80)" required>
            <input type="number" id="temp" placeholder="Temperature (°C)" required step="0.1">
            <input type="number" id="pulse" placeholder="Pulse Rate (bpm)" required>
            <input type="number" id="weight" placeholder="Weight (kg)" required step="0.1">
            <input type="number" id="height" placeholder="Height (cm)" required>
        </div>
        <div class="form-actions">
            <button id="saveVitals" style="background-color: #22c35e; color: white;">Save Vitals</button>
        </div>
    </div>
    
    <div id="consultation" class="section" style="display:none;">
        <form id="consultForm">
            <h3>Consultation Notes</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <select id="consultPatientSelect" required>
                    <option value="">-- Select Patient for Consultation --</option>
                    </select>
                <button type="button" id="loadTriage" style="background-color: #f59e0b; color: white; padding: 10px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer;">Load Latest Vitals</button>
                <div id="triagePreview">Triage details will appear here.</div>

                <textarea name="Diagnosis" placeholder="Diagnosis (e.g., Malaria, URI)" class="form-full-width" rows="3" required></textarea>
                <textarea name="Notes" placeholder="Doctor's detailed notes and treatment plan" class="form-full-width" rows="4"></textarea>
                <textarea name="Drugs" placeholder="Prescription (e.g., Paracetamol 500mg, Amoxil 250mg)" class="form-full-width" rows="2"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" style="background-color: #3b82f6; color: white;">Finalize Consultation & Save</button>
            </div>
        </form>
    </div>

    <div id="lab" class="section" style="display:none;">
        <h3>Laboratory Management</h3>
        <p>Lab requests and results management coming soon.</p>
    </div>

    <div id="pharmacy" class="section" style="display:none;">
        <h3>Pharmacy Dispensing</h3>
        <p>Drug dispensing and inventory management coming soon.</p>
    </div>

    <div id="billing" class="section" style="display:none;">
        <h3>Generate Invoice</h3>
        <div class="form-grid" style="grid-template-columns: 1fr;">
            <select id="billPatientSelect" required>
                <option value="">-- Select Patient for Billing --</option>
                </select>
            <button id="generateBill" style="background-color: #6366f1; color: white; padding: 10px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer;">Generate Bill</button>
        </div>
        
        <div id="invoicePreview">
            </div>
    </div>

    <div id="reports" class="section" style="display:none;">
        <h3>System Reports and Analytics</h3>
        <p>Reporting tools coming soon.</p>
    </div>
    
    <footer style="text-align: center; margin-top: 40px; color: #6b7280; font-size: 0.8rem;">
        Powered by Google Sheets & Apps Script
    </footer>
  </div>

  <script>
    /* * IMPORTANT: This script block contains all the client-side JavaScript 
     * necessary for navigation, login, and communication with the Code.gs 
     * Apps Script file using google.script.run.
     */

    // ------------------------------------------------
    // Core GAS Utilities
    // ------------------------------------------------

    /**
     * Universal failure handler for google.script.run calls.
     */
    function onServerFailure(error) {
      console.error("Server-side error:", error);
      alert('Server Error: ' + error.message);
    }

    /**
     * Generic function to fetch and populate patient dropdowns across the app.
     */
    function populatePatientSelects(patients) {
      const selectIds = ['triageSelectPatient', 'consultPatientSelect', 'billPatientSelect'];

      selectIds.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;

        // Clear existing options
        select.innerHTML = '<option value="">-- Select Patient --</option>';

        patients.forEach(patient => {
          const option = document.createElement('option');
          option.value = patient.id; // Use PatientID from the sheet
          option.textContent = `${patient.Name} (${patient.ID})`; // Use correct case from sheet data
          select.appendChild(option);
        });
      });
    }

    /**
     * Renders the Patients List table in the Registration/Dashboard sections.
     */
    function updatePatientsList(patients) {
      const tables = {
        dashboardPatientsTable: ['ID', 'Name', 'Age', 'Phone'],
        patientsTable: ['ID', 'Name', 'Age', 'Phone']
      };

      for (const [tableId, fields] of Object.entries(tables)) {
        const tableElement = document.getElementById(tableId);
        if (!tableElement) continue;

        const tbody = tableElement.querySelector('tbody');
        if (!tbody) continue;

        tbody.innerHTML = '';
        patients.forEach(patient => {
          const row = tbody.insertRow();
          fields.forEach(field => {
            row.insertCell().textContent = patient[field]; // Use correct case from sheet data
          });
          // Add 'Actions' button for the main list
          if (tableId === 'patientsTable') {
            row.insertCell().innerHTML = '<button class="btn" style="background:#ef4444; padding: 4px 8px; font-size: 12px;">Edit</button>';
          }
        });
      }
    }


    // ------------------------------------------------
    // Navigation & Login Logic (Modified for GAS Load)
    // ------------------------------------------------

    (function(){
      const nav = document.getElementById('nav');
      const sections = document.querySelectorAll('.section');
      const pageTitle = document.getElementById('pageTitle');
      const loginModal = document.getElementById('loginModal');
      const loginForm = document.getElementById('loginForm');
      const demoBtn = document.getElementById('demoLogin');
      const logoutBtn = document.getElementById('logoutBtn');
      const openRegistration = document.getElementById('openRegistration');
      const patientForm = document.getElementById('patientForm');
      const saveVitalsBtn = document.getElementById('saveVitals');
      const consultForm = document.getElementById('consultForm');
      const generateBillBtn = document.getElementById('generateBill');
      
      // Simple UI Navigation
      nav.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-target]');
        if(!btn) return;
        nav.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.target;
        sections.forEach(s => s.style.display = s.id === target ? '' : 'none');
        pageTitle.textContent = btn.textContent.trim();
        // Reset subtitle for new page
        document.getElementById('pageSubtitle').textContent = {
            'dashboard': 'Quick overview',
            'registration': 'Register new patients',
            'triage': 'Record patient vitals',
            'consultation': 'Doctor\'s notes and diagnosis',
            'lab': 'Manage lab requests',
            'pharmacy': 'Dispense prescriptions',
            'billing': 'Generate invoices',
            'reports': 'System analytics'
        }[target] || '';
      });

      // Login/Logout Logic (Uses localStorage for simulation only)
      function finishLogin(username){
        loginModal.style.display='none';
        localStorage.setItem('hms_session', JSON.stringify({user:username,role: username==='admin' ? 'Admin' : 'Staff'}));
        document.querySelector('.sidebar div:nth-child(2) div').textContent = username;
        // Reload data after successful login
        loadInitialData(); 
      }

      loginForm.addEventListener('submit', (ev)=>{
        ev.preventDefault();
        const fd = new FormData(loginForm);
        const u = fd.get('username').trim();
        const p = fd.get('password').trim();
        // hardcoded credentials
        if((u==='admin' && p==='admin123') || (u==='staff' && p==='staff123')){
          finishLogin(u);
        } else {
          alert('Invalid credentials for demo. Use admin/admin123 or staff/staff123');
        }
      });

      demoBtn.addEventListener('click', ()=> finishLogin('staff'));
      
      logoutBtn.addEventListener('click', ()=>{
        localStorage.removeItem('hms_session');
        loginModal.style.display='';
        document.querySelector('#nav button[data-target="dashboard"]').click();
        document.querySelector('.sidebar div:nth-child(2) div').textContent = 'Staff';
      });

      // Quick open registration from dashboard
      openRegistration.addEventListener('click', ()=> {
        document.querySelector('#nav button[data-target="registration"]').click();
      });
      
      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.addEventListener('change', (e)=>{
        if(e.target.checked) document.documentElement.style.filter = 'invert(0.98) hue-rotate(180deg)';
        else document.documentElement.style.filter = '';
      });
      
      // Data Loader Function
      function loadInitialData() {
          // Fetch initial patient data from the sheet when the page loads
          google.script.run
              .withFailureHandler(onServerFailure)
              .withSuccessHandler((patients) => {
                  updatePatientsList(patients);
                  populatePatientSelects(patients);
                  // Update dashboard stats (simplified counts)
                  document.getElementById('statPatients').textContent = patients.length;
                  document.getElementById('statVisits').textContent = patients.length; 
              })
              .getPatients();
      }

      // Check session on load
      window.addEventListener('load', ()=>{
        const s = localStorage.getItem('hms_session');
        if(s){ 
          loginModal.style.display='none'; 
          const u = JSON.parse(s).user; 
          document.querySelector('.sidebar div:nth-child(2) div').textContent = u; 
          loadInitialData(); // Load data if logged in
        } else { 
          loginModal.style.display=''; 
        }
      });
      
      // ------------------------------------------------
      // Form Submission Logic (using google.script.run)
      // ------------------------------------------------

      // 1. Patient Registration Form Handler
      patientForm.addEventListener('submit', (ev) => {
          ev.preventDefault();
          const formData = Object.fromEntries(new FormData(patientForm).entries());

          google.script.run
              .withFailureHandler(onServerFailure)
              .withSuccessHandler((message) => {
                  alert(message);
                  patientForm.reset();
                  // Refresh lists and dropdowns after successful save
                  google.script.run.withSuccessHandler((patients) => {
                      updatePatientsList(patients);
                      populatePatientSelects(patients);
                  }).getPatients();
              })
              .savePatient(formData);
      });
      
      // 2. Triage/Vitals Save Handler
      saveVitalsBtn.addEventListener('click', () => {
          const patientId = document.getElementById('triageSelectPatient').value;
          const bp = document.getElementById('bp').value;
          const temp = document.getElementById('temp').value;
          const pulse = document.getElementById('pulse').value;
          const weight = document.getElementById('weight').value;
          const height = document.getElementById('height').value;

          if (!patientId || !bp || !temp || !pulse || !weight || !height) {
              alert('Please fill all vitals fields and select a patient.');
              return;
          }

          google.script.run
              .withFailureHandler(onServerFailure)
              .withSuccessHandler((message) => {
                  alert(message);
                  // Clear inputs after save
                  document.getElementById('bp').value = '';
                  document.getElementById('temp').value = '';
                  document.getElementById('pulse').value = '';
                  document.getElementById('weight').value = '';
                  document.getElementById('height').value = '';
              })
              .saveVitals(patientId, bp, temp, pulse, weight, height);
      });
      
      // 3. Consultation Load Triage Button Handler
      document.getElementById('loadTriage').addEventListener('click', () => {
          const patientId = document.getElementById('consultPatientSelect').value;
          if (!patientId) {
              alert('Please select a patient first.');
              return;
          }

          google.script.run
              .withFailureHandler(onServerFailure)
              .withSuccessHandler((vitals) => {
                  const preview = document.getElementById('triagePreview');
                  if (vitals) {
                      preview.innerHTML = `
                          **Latest Triage:** BP: ${vitals.BP}, Temp: ${vitals.Temp}°C, Pulse: ${vitals.Pulse}, Weight: ${vitals.Weight}
                      `;
                  } else {
                      preview.textContent = 'No vitals found for this patient.';
                  }
              })
              .getLatestVitals(patientId);
      });
      
      // 4. Consultation Form Handler
      consultForm.addEventListener('submit', (ev) => {
          ev.preventDefault();
          const patientId = document.getElementById('consultPatientSelect').value;
          if (!patientId) {
              alert('Please select a patient.');
              return;
          }

          const formData = Object.fromEntries(new FormData(consultForm).entries());
          
          google.script.run
              .withFailureHandler(onServerFailure)
              .withSuccessHandler((message) => {
                  alert(message);
                  consultForm.reset();
                  document.getElementById('triagePreview').textContent = 'Triage details will appear here.';
              })
              .saveConsultation(patientId, formData);
      });
      
      // 5. Billing Generation Handler
      generateBillBtn.addEventListener('click', () => {
          const patientId = document.getElementById('billPatientSelect').value;
          if (!patientId) {
              alert('Please select a patient to generate a bill.');
              return;
          }

          google.script.run
              .withFailureHandler(onServerFailure)
              .withSuccessHandler((result) => {
                  alert(result.message);
                  const preview = document.getElementById('invoicePreview');
                  preview.style.display = 'block';
                  
                  if (result.invoice) {
                      preview.innerHTML = `
                          <h4>Invoice Preview (${result.invoice.number})</h4>
                          <p>Consultation: KSH ${result.invoice.consult}</p>
                          <p>Lab: KSH ${result.invoice.lab}</p>
                          <p>Pharmacy: KSH ${result.invoice.pharmacy}</p>
                          <hr style="margin: 8px 0;">
                          <p style="font-weight: bold;">TOTAL: KSH ${result.invoice.total}</p>
                      `;
                  } else {
                      // If message contains the reason why invoice wasn't generated
                      preview.innerHTML = `<h4>Status</h4><p>${result.message}</p>`;
                  }
              })
              .generateBill(patientId);
      });

    })();
  </script>
</body>
</html>
